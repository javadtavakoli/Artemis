<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE artemis PUBLIC "-//Devocative.Org//Artemis 1.0//EN"
		"https://devocative.org/dtd/artemis-1.0.dtd">

<artemis>
	<vars>
		<var name="cell" value="09${_.generate(9, '0'..'9')}"/>
		<var name="password" value="${_.generate(9, '0'..'9', 'a'..'z')}"/>
	</vars>

	<scenario name="RegisterUser">
		<post url="/registrations">
			<body type="json"><![CDATA[
{
	"name": "Foo\\nBar",
	"cell": "${cell}"
}
			]]></body>

			<assertRs status="200" body="empty"/>
		</post>

		<get url="/registrations/${cell}">
			<assertRs status="200" properties="smsCode"/>
		</get>

		<put url="/registrations" id="verify">
			<body><![CDATA[
{
	"smsCode": "${_prev.rs.smsCode}",
	"password": "${password}"
}
			]]></body>

			<assertRs status="201" properties="token,userId"/>
		</put>

		<put url="/users/${verify.rs.userId}">
			<headers>
				<header name="Authorization" value="${verify.rs.token}"/>
			</headers>

			<body><![CDATA[
{
	"city": "Tehran",
	"email": "a@a.com"
}
			]]></body>

			<assertRs status="200"/>
		</put>
	</scenario>

	<scenario name="ProductCRUD">
		<get url="/login/${cell}">
			<assertRs status="200" properties="smsCode"/>
		</get>

		<post id="login" url="/login">
			<body><![CDATA[
{
	"cell": "${cell}",
	"password": "${password}",
	"smsCode": "${_prev.rs.smsCode}"
}
			]]></body>

			<assertRs status="200" properties="token"/>
		</post>
	</scenario>
</artemis>
